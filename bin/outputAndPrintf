#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
If there's output (with -w|--non-whitespace: output that does contains at least
one non-whitespace character), printf FORMAT [ARGUMENTS ...] (with -2|--stderr:
to standard error) is printed before (with -a|--append: after) it.
If no output is piped into the command, nothing is printed, and the exit status
is 1.
HELPTEXT
    printf 'Usage: cat FILE [...] | %q %s\n' "$(basename "$1")" '[-w|--non-whitespace] [-2|--stderr] [-a|--append] FORMAT [ARGUMENTS ...] [-?|-h|--help]'
}

redir=
typeset -a beforeArg=(--before)
typeset -a forwardedArgs=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--non-whitespace|-w)	forwardedArgs+=("$1"); shift;;
	--stderr|-2)		shift; redir='>&2';;
	--append|-a)		shift; beforeArg=();;
	--)		shift; break;;
	*)		break;;
    esac
done
if [ $# -eq 0 ]; then
    printUsage "$0" >&2
    exit 2
fi

printf -v quotedPrintfArgs '%q ' "$@"; quotedPrintfArgs=${quotedPrintfArgs% }
exec outputAnd "${beforeArg[@]}" "${forwardedArgs[@]}" --command "printf $redir $quotedPrintfArgs"
